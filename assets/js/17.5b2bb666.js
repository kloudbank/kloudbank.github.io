(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{714:function(s,a,t){s.exports=t.p+"assets/img/2021-07-28-14-46-57.ef624b29.png"},715:function(s,a,t){s.exports=t.p+"assets/img/2021-07-28-14-58-10.598a4f77.png"},716:function(s,a,t){s.exports=t.p+"assets/img/2021-07-28-15-06-22.b3dc3850.png"},717:function(s,a,t){s.exports=t.p+"assets/img/2021-07-28-15-18-39.dd0082d7.png"},785:function(s,a,t){"use strict";t.r(a);var e=t(15),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("AWS 에서 제공하는 Service Mesh 인 Amazon App Mesh 에서, Flagger 를 활용한 Kubernetes Object Delivery 환경 구성 및 FluxCD 기반 Amazon EKS GitOps 환경과의 통합.")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("App Mesh integration with Amazon EKS")]),s._v(" "),e("ul",[e("li",[s._v("Kubernetes custom resources : mesh, virtual nodes, routers, services 활용 (외부 노출을 위한 Virtual Gateway 는 제외)")]),s._v(" "),e("li",[s._v("CRD controller : App Mesh control plane 과 custom resource 의 동기화")]),s._v(" "),e("li",[s._v("Admission controller : Envoy sidecar injection 과 App Mesh virtual nodes 에 service (pod) assign")]),s._v(" "),e("li",[s._v("Telemetry service : appmesh 에서 제공하는 prometheus 활용")]),s._v(" "),e("li",[s._v("Progressive delivery operator : Flagger instance 를 활용한 canary release automation")])])])]),s._v(" "),e("img",{attrs:{src:"https://eks.handson.flagger.dev/gitops-appmesh-stack.png"}}),s._v(" "),e("blockquote",[e("p",[s._v("EKS GitOps Handson 참조"),e("br"),s._v(" "),e("a",{attrs:{href:"https://eks.handson.flagger.dev/profile/#app-mesh-profile",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://eks.handson.flagger.dev/profile/#app-mesh-profile"),e("OutboundLink")],1)])]),s._v(" "),e("h2",{attrs:{id:"prerequisite"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#prerequisite"}},[s._v("#")]),s._v(" Prerequisite")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("GitOps Pipeline")]),s._v(" "),e("ul",[e("li",[s._v("사전에 구성한 Amazon EKS cluster (ver. >= 1.16)")]),s._v(" "),e("li",[s._v("사전에 구성한 ECR")]),s._v(" "),e("li",[s._v("사전에 구성한 AWS Code Pipeline (CodeCommit + CodeBuild)")]),s._v(" "),e("li",[s._v("FluxCD 기반 k8s manifest repository 의 Pull based Deployment 환경")])])]),s._v(" "),e("li",[e("p",[s._v("Delivery Process")]),s._v(" "),e("ul",[e("li",[s._v("App Mesh Component 및 Prometheus 설치")]),s._v(" "),e("li",[s._v("Flagger 설치")])])])]),s._v(" "),e("blockquote",[e("p",[s._v("Flagger Official Docs 참조"),e("br"),s._v(" "),e("a",{attrs:{href:"https://docs.flagger.app/install/flagger-install-on-eks-appmesh",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://docs.flagger.app/install/flagger-install-on-eks-appmesh"),e("OutboundLink")],1)])]),s._v(" "),e("h3",{attrs:{id:"install-app-mesh-components"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#install-app-mesh-components"}},[s._v("#")]),s._v(" Install App Mesh Components")]),s._v(" "),e("ul",[e("li",[s._v("Helm repository 추가")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("helm repo "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" eks https://aws.github.io/eks-charts\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("App Mesh CRD 설치 및 namespace 생성:")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl apply -k github.com/aws/eks-charts/stable/appmesh-controller//crds?ref"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("master\n\nkubectl create ns appmesh-system\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ul",[e("li",[s._v("App Mesh controller helm install")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("helm upgrade -i appmesh-controller eks/appmesh-controller "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--wait --namespace appmesh-system\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[s._v("App Mesh Prometheus helm install"),e("br"),s._v("\n: Flagger 의 canary analysis 를 위해 필요한, App Mesh metric 수집을 위해 설치")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("helm upgrade -i appmesh-prometheus eks/appmesh-prometheus "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--wait --namespace appmesh-system\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h3",{attrs:{id:"install-flagger"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#install-flagger"}},[s._v("#")]),s._v(" Install Flagger")]),s._v(" "),e("ul",[e("li",[s._v("Helm repository 추가")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("helm repo "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" flagger https://flagger.app\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("Flagger CRD 설치"),e("br"),s._v("\n: Canary, AlertProvider, MetricTemplate,,")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl apply -f https://raw.githubusercontent.com/fluxcd/flagger/main/artifacts/flagger/crd.yaml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("App Mesh namespace 에 flagger helm install")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("helm upgrade -i flagger flagger/flagger "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--namespace"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("appmesh-system "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--set crd.create"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--set "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("meshProvider")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("appmesh:v1beta2 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--set "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("metricsServer")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://appmesh-prometheus:9090\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ul",[e("li",[s._v("Monitoring 을 위한, Flagger Grafana helm install")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("helm upgrade -i flagger-grafana flagger/grafana "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--set "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("url")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://prometheus:9090\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h2",{attrs:{id:"service-mesh-canary-release"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#service-mesh-canary-release"}},[s._v("#")]),s._v(" Service Mesh Canary release")]),s._v(" "),e("p",[s._v("Service Mesh 기반 Flagger 의 Canary Release 에 대한 구성 내역."),e("br"),s._v("\nFlagger 의 Canary custom resource 를 정의하여, Amazon App Mesh 기반의 canary release automation process 를 구성하였다.")]),s._v(" "),e("blockquote",[e("p",[s._v("Flagger Official Docs 참조"),e("br"),s._v(" "),e("a",{attrs:{href:"https://docs.flagger.app/tutorials/appmesh-progressive-delivery",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://docs.flagger.app/tutorials/appmesh-progressive-delivery"),e("OutboundLink")],1)])]),s._v(" "),e("h3",{attrs:{id:"app-mesh-flagger"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#app-mesh-flagger"}},[s._v("#")]),s._v(" App Mesh + Flagger")]),s._v(" "),e("p",[s._v("Flagger 는 Canary resource 에 정의된 target deployment 및 hpa 를 기반으로, primary 기준이 되는 deployment, service, hpa 등을 생성하는 것 뿐 아니라, 정의된 provider 에 맞는 service mesh 에 필요한 custom resource 를 생성한다.")]),s._v(" "),e("p",[s._v("App Mesh 의 경우, 수동으로 환경을 구성할 경우, Mesh, VirtualNode, VirtualService, VirtualRouter 등을 직접 k8s manifest 정의하고 apply 하여 생성해야 한다."),e("br"),s._v("\n하지만, Flagger 의 Canary resource 를 활용하여 정의할 경우, 관련된 primary, canary route 를 위한 virtual node, service, router 를 자동으로 생성해주므로, App Mesh 구성을 위해 global 영역의 논리적 경계를 정의하는 mesh 만 직접 생성하였다.")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("Mesh resource manifest")])])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" appmesh.k8s.aws/v1beta2\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Mesh\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" global\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaceSelector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("appmesh.k8s.aws/sidecarInjectorWebhook")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" enabled\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("egressFilter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ALLOW_ALL\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("ul",[e("li",[e("strong",[s._v("Virtual node, router, service 를 직접 생성할 경우 예시")])])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# VirtualNode: k8s service 의 logical pointer 역할")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" appmesh.k8s.aws/v1beta2\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" VirtualNode\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mariadb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("shop\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mariadb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("shop\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("listeners")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("portMapping")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" tcp\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceDiscovery")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dns")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service 지정")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostname")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mariadb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("shop.shop"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("infra.svc.cluster.local.\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# VirtualRouter: VirtualService 의 traffic 을 VirtualNode 로 routing")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" appmesh.k8s.aws/v1beta2\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" VirtualRouter\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mariadb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("shop\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("listeners")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("portMapping")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" tcp\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("routes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" route"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("to"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("mariadb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("shop\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tcpRoute")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("weightedTargets")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("virtualNodeRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mariadb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("shop\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("weight")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# VirtualService: 실제 k8s service 를 추상화한 object. service name 과 동일하게 생성")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" appmesh.k8s.aws/v1beta2\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" VirtualService\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mariadb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("shop\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("awsName")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mariadb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("shop.shop"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("infra\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("provider")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("virtualRouter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("virtualRouterRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mariadb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("shop\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br")])]),e("ul",[e("li",[e("strong",[s._v("App Mesh Traffic Flow 예시")])])]),s._v(" "),e("img",{attrs:{src:"https://docs.aws.amazon.com/app-mesh/latest/userguide/images/simple-app-with-mesh-diagram.png"}}),s._v(" "),e("blockquote",[e("p",[s._v("Amazon App Mesh Official Docs 참조"),e("br"),s._v(" "),e("a",{attrs:{href:"https://docs.aws.amazon.com/app-mesh/latest/userguide/what-is-app-mesh.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://docs.aws.amazon.com/app-mesh/latest/userguide/what-is-app-mesh.html"),e("OutboundLink")],1)])]),s._v(" "),e("h3",{attrs:{id:"flagger-canary-resource"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#flagger-canary-resource"}},[s._v("#")]),s._v(" Flagger Canary resource")]),s._v(" "),e("p",[s._v("기존에 FluxCD 기반으로 배포되어 있던, deployment, hpa 구성을 target 으로 하는 Canary Resource 를 생성한 내역")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("Canary resource manifest 예시")])])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flagger.app/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Canary\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" <name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("provider")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" appmesh"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("v1beta2\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# target deployment 정의")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" <name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("progressDeadlineSeconds")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# target hpa 정의")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("autoscalerRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" autoscaling/v2beta2\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" HorizontalPodAutoscaler\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" <name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# expose 를 위한 service 정의 (ClusterIP)")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" <port"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("backends")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# App Mesh 일 경우, virtual service egress 허용을 위해 추가해주어야 하는 내용")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" arn"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("aws"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("appmesh"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("ap"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("northeast"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("170247361816"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("mesh/global/virtualService/mariadb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("shop.shop"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("infra\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" arn"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("aws"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("appmesh"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("ap"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("northeast"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("170247361816"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("mesh/global/virtualService/rabbitmq.shop"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("infra\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" arn"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("aws"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("appmesh"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("ap"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("northeast"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("170247361816"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("mesh/global/virtualService/redis"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("session.shop"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("infra\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# canary analysis 정의 영역")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("skipAnalysis")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# true 일 경우, 곧바로 canary promotion")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("analysis")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# schedule interval (default 60s)")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 30s\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max number of failed metric checks before rollback")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("threshold")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 도달하기 위한 최대 가중치 값 정의, percentage (0-100)")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("maxWeight")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# traffic 가중치 증가 단위, percentage (0-100)")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stepWeight")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# App Mesh Prometheus 의 metric check")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### flagger 의 service mesh metric check 는 기본적으로 아래의 2가지 항목을 제공")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### request 성공률, duration")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metrics")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("success"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rate\n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# minimum req success rate (non 5xx responses), percentage (0-100)")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("thresholdRange")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("min")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("99")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1m\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" request"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("duration\n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# maximum req duration P99, milliseconds")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("thresholdRange")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 30s\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 생성한 alert provider 를 reference 로 하여, slack channel 에 message 전송")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### slack web hook url 기반으로 namespace 에 alert provider 미리 생성함.")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alerts")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dev team Slack"')]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("severity")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" info\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("providerRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" on"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("call\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" shop\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# webhook 기반 Testing (optional)")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### rollout type 으로 정의하여, weight 가 변경될 때 마다, curl command 를 호출하는 url 호출")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### flagger-loadtester application 을 미리 배포하였음.")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("webhooks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" acceptance"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rollout\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("url")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//flagger"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("loadtester.shop/\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("timeout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 60s\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" bash\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cmd")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"curl -X GET http://account-canary.shop:8180/v1/accounts/events"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br")])]),e("ul",[e("li",[e("strong",[s._v("Alert Provider 생성 manifest 예시")])])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flagger.app/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" AlertProvider\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" on"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("call\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" slack\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("channel")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" on"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("call"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alerts\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flagger\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# webhook address (ignored if secretRef is specified)")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("address")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" <webhook address"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("ul",[e("li",[e("strong",[s._v("Canary resource 생성 시, generate 되는 object 내역")]),e("br"),s._v("\n: app name 은 account")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Flagger canary resource")]),s._v("\ncanary.flagger.app/account\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# target deployment, hpa 의 primary object")]),s._v("\ndeployment.apps/account-primary\nhorizontalpodautoscaler.autoscaling/account-primary\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# primary service 와 weight routing 을 위한 canary service")]),s._v("\nservice/account                ClusterIP\nservice/account-canary         ClusterIP\nservice/account-primary        ClusterIP\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# App Mesh resource, AWS 의 arn 이 부여됨.")]),s._v("\nvirtualnode.appmesh.k8s.aws/account-canary       arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualNode/account-canary_shop\nvirtualnode.appmesh.k8s.aws/account-primary      arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualNode/account-primary_shop\nvirtualrouter.appmesh.k8s.aws/account            arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualRouter/account_shop\nvirtualrouter.appmesh.k8s.aws/account-canary     arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualRouter/account-canary_shop\nvirtualservice.appmesh.k8s.aws/account           arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualService/account.shop\nvirtualservice.appmesh.k8s.aws/account-canary    arn:aws:appmesh:ap-northeast-2:170247361816:mesh/global/virtualService/account-canary.shop\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("h3",{attrs:{id:"automated-canary-promotion"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#automated-canary-promotion"}},[s._v("#")]),s._v(" Automated Canary Promotion")]),s._v(" "),e("p",[s._v("Spring Boot Application 의 application property 를 configmap volume 으로 mount 한 application 의 Canary release demo.")]),s._v(" "),e("h4",{attrs:{id:"test-scenario"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#test-scenario"}},[s._v("#")]),s._v(" Test Scenario")]),s._v(" "),e("ol",[e("li",[s._v("k8s manifest git repository 의, spring boot application property 를 수정 후 commit & push.")]),s._v(" "),e("li",[s._v("FluxCD 에 의해서, kustomize reconciliation 수행하여, k8s configmap 재생성.")]),s._v(" "),e("li",[s._v("Flagger 에서 configmap 의 변경 event 를 감지하여, canary release process 시작.")]),s._v(" "),e("li",[s._v("Canary Release"),e("br"),s._v("\n4-1. 변경된 configmap 으로 인해 application error 발생으로 pod 생성 실패"),e("br"),s._v("\n4-2. alert provider 에 의해 slack message 수신")]),s._v(" "),e("li",[s._v("k8s manifest git repository 의, spring boot application property 올바른 값으로 수정 및 commit & push.")]),s._v(" "),e("li",[s._v("2 ~ 4번 과정 다시 반복.")]),s._v(" "),e("li",[s._v("Canary Release"),e("br"),s._v("\n7-1. request-success-rate metric 분석 threshold check 실패"),e("br"),s._v("\n7-2. alert provider 에 의해 slack message 수신")]),s._v(" "),e("li",[s._v("Flagger canary resource 의 metric threshold 조정")]),s._v(" "),e("li",[s._v("Deployment rollout restart 수행.")]),s._v(" "),e("li",[s._v("Alert provider 에 의해 slack message 수신.")])]),s._v(" "),e("img",{attrs:{src:"https://www.plantuml.com/plantuml/svg/bLLBRnen4BxxLpZqq8qKeArwg7fAIjeU-WWAwg6doDW3MFWbsqkILldl6NiVx9840WTszfllcnbxnklp49cFfLQ4BAoDuEcFSWxUG8H0fugPEFppwoS9d2cWcjtHz-y-VAItKiGL8M4jZMEUQMgiW00ElHtGCxEkGVAs4vUS25X80nreYXNGLOmkV1wFFRiTBMLSbVCoWEVMH31nnAqU2yu2YtAyReN3N2EMEDOiOFbZ8KCav4GQhae1fLSxMJhQcudLsfgHIyj_hGABkOl7I6PIEoKN4aIbsYUxcit6MsYsuGSJzHLJAuvKJFIn0dziYajmojxNYsSyMay7bx0P3IWBD7NuGaaMIBIEHaldDaQhgP0UU9JM429OP7CMW0xMdmB5mQ0UdCrg1F2T56-2Odnzcg1izUUDOf-TDJX4WKnKcSRaveijZM3-lk0LS4O7NK453axfVqBnzvjf28vnsEeMghmp0MNVq9XSjbHAU-qeWYqz1-HLnZ2DixTAONG41wVFYjQOtg8xFxNyzuBiuUNYs7A9yQhwijqfS3TRpKPkRHsPZJcNCrquDteX3Ovo4JOyRGFuZUJGM_mpp0vro9d1D8SKhgDmNkfzahHgPPb0Co8dcSDaxpHbL-AiG3V-7sAvYdQmZkfe528_a5GPhwExbdympKGNNACJsxf0fjjFT0rpYTJ3iRqegWObsVvE9IxU8pxjUNvYTBkHOcVC7WYv1bMqduQpwfYV3IXIagT-tpbQbECbHF6cCZMjzZU7oTWeHqs4ZELDkGPSB9UOA7rkq5zfqx3cEMopDf3hGOYbiUX2BaCrBOE9WSbQKdQddTvIKYtRW_WT8lswmIzMBKZUkZDvYobkdBQvOCGcLzE_JPmsHZjKJTBMqxRhYQTp9fxuciQr5JS9gbFHyDlXh8z17s_AUirAcZAhxyOjoEKgqXKpGa6pArl6bfB2uDNa0Q-CfppNumbeUPcuNN-Lj5rhlVXykJJuEHY1TzeZ",alt:"kubernetes"}}),s._v(" "),e("h3",{attrs:{id:"test-result"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#test-result"}},[s._v("#")]),s._v(" Test Result")]),s._v(" "),e("p",[s._v("Case 별 Test 내역 정리.")]),s._v(" "),e("h4",{attrs:{id:"_1-configmap-변경에-의한-canary-release"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-configmap-변경에-의한-canary-release"}},[s._v("#")]),s._v(" 1.Configmap 변경에 의한, Canary release")]),s._v(" "),e("ul",[e("li",[s._v("잘못된 db connection 설정하여 git commit & push.")])]),s._v(" "),e("div",{staticClass:"language-git line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-git"}},[e("code",[e("span",{pre:!0,attrs:{class:"token command"}},[s._v("$ git diff HEAD^ HEAD")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token deleted"}},[s._v("--- a/clusters/eks/shop/prd/account/application-prd.yml")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token inserted"}},[s._v("+++ b/clusters/eks/shop/prd/account/application-prd.yml")]),s._v("\n@@ -11,7 +11,7 @@ spring:\n     database-platform: org.hibernate.dialect.MariaDB103Dialect\n   datasource:\n     driver-class-name: org.mariadb.jdbc.Driver\n"),e("span",{pre:!0,attrs:{class:"token deleted"}},[s._v("-    url: jdbc:mariadb://mariadb-shop.shop-infra/accounts?characterEncoding=UTF-8")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token inserted"}},[s._v("+    url: jdbc:mariadb://mariadb-shop-new.shop-infra/accounts?characterEncoding=UTF-8")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("ul",[e("li",[s._v("FluxCD 에 의해 configmap account 만 변경 되고, 이로 인하여 Flagger 가 Canary release start"),e("br"),s._v("\n: configmap 변경 영향으로, 새로 생성된 pod 에서 error 발생하여 canary release 불가.")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ kubectl get cm\n\nNAME                          DATA\naccount                       "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("   \naccount-primary               "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("   \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ul",[e("li",[s._v("Canary release alert 수신"),e("br"),s._v(" "),e("img",{attrs:{src:t(714),width:"40%",height:"40%"}})])]),s._v(" "),e("h4",{attrs:{id:"_2-canary-analysis-metric-threshold-check-실패"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-canary-analysis-metric-threshold-check-실패"}},[s._v("#")]),s._v(" 2. Canary analysis metric threshold check 실패")]),s._v(" "),e("p",[s._v("threshold 100% 에 success rate 가 도달하지 못하여, canary release 실패.")]),s._v(" "),e("ul",[e("li",[s._v("canary describe 내역"),e("br"),s._v("\n: controller 에서 log 내역으로도 확인 가능하며, canary resource 의 status monitoring 도 가능.")])]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[s._v("$ kubectl "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("describe")]),s._v(" canary\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\nEvents:\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Type")]),s._v("     Reason  Age                "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("From")]),s._v("     Message\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("----     ------  ----               ----     -------")]),s._v("\n  Normal   Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("m                flagger  Copying account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop template spec "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" account"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("primary")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop\n  Normal   Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("49")]),s._v("m                flagger  Routing "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("all")]),s._v(" traffic "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("primary")]),s._v("\n  Normal   Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("49")]),s._v("m                flagger  Promotion completed"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Scaling down account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop\n  Normal   Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v("m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("x2 "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("over")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),s._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  flagger  New revision detected"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Scaling up account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop\n  Normal   Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v("m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("x2 "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("over")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  flagger  Advance account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop canary weight "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v("\n  Normal   Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),s._v("m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("x2 "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("over")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  flagger  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Starting")]),s._v(" canary analysis "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop\n  Normal   Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("x2 "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("over")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  flagger  Advance account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop canary weight "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("\n  Warning  Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("m                flagger  Halt account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop advancement success rate "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("99.74")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("\n  Warning  Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v("m                flagger  Halt account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop advancement success rate "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("99.54")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("\n  Warning  Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v("m                flagger  Halt account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop advancement success rate "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("99.58")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("\n  Warning  Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("m                flagger  Halt account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop advancement success rate "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("99.61")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("\n  Warning  Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("m                flagger  Halt account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop advancement success rate "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("99.53")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("\n  Warning  Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),s._v("m                flagger  Halt account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop advancement success rate "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("99.66")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("\n  Warning  Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v("m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("x3 "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("over")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),s._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  flagger  Halt account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop advancement success rate "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("99.65")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("\n  Warning  Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v("m                flagger  Rolling back account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop failed checks threshold reached "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n  Warning  Synced  "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),s._v("m                flagger  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("combined "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" similar events"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": Canary failed"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Scaling down account"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shop\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br")])]),e("ul",[e("li",[s._v("Flagger Dashboard 를 통한 Monitoring"),e("br"),s._v("\n: appmesh 의 prometheus metric 을 활용. Flagger 도 마찬가지.")])]),s._v(" "),e("p",[e("img",{attrs:{src:t(715),alt:""}})]),s._v(" "),e("ul",[e("li",[s._v("AWS X-ray Monitoring"),e("br"),s._v("\n: 실제로 pod 간에 traffic 분산이 잘되었는지 확인하고, 어떤 pod 에서 error 가 발생하였는지 확인."),e("br"),s._v("\n: 아래 컴포넌트의 error 발생율 만큼, 붉은 색으로 표시됨."),e("br"),s._v(" "),e("u",[e("em",[s._v("traffic 분산 처리가 정말로 잘 되는지 의심스러워서 확인해 봄,,")])])])]),s._v(" "),e("p",[e("img",{attrs:{src:t(716),alt:""}})]),s._v(" "),e("h4",{attrs:{id:"_3-canary-analysis-metric-threshold-조정"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-canary-analysis-metric-threshold-조정"}},[s._v("#")]),s._v(" 3. Canary analysis metric threshold 조정")]),s._v(" "),e("p",[s._v("threshold 조정 후, Canary release 재시작."),e("br"),s._v("\nmetric threshold 변경으로 인해, k8s canary resource 가 수정되었더라도, Pod Spec, configmap, secret 의 변경이 없으므로, flagger 가 canary release 를 자동으로 수행하지 않음.")]),s._v(" "),e("p",[s._v("Deployment 를 rollout restart 하여 canary release start.")]),s._v(" "),e("ul",[e("li",[s._v("Canary analysis 의 threshold range 수정 후, git commit & push"),e("br"),s._v("\n: 이후, deployment restart.")])]),s._v(" "),e("div",{staticClass:"language-git line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-git"}},[e("code",[s._v("@@ -59,7 +59,7 @@ spec:\n       # minimum req success rate (non 5xx responses)\n       # percentage (0-100)\n       thresholdRange:\n"),e("span",{pre:!0,attrs:{class:"token deleted"}},[s._v("-        min: 100")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token inserted"}},[s._v("+        min: 95")]),s._v("\n       interval: 3m\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("ul",[e("li",[s._v("Canary status 확인"),e("br"),s._v("\n: 정상적으로 metric threshold check 완료 되어, canary promotion 수행.")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Events:\n  Type     Reason  Age                  From     Message\n  ----     ------  ----                 ----     -------\n  Normal   Synced  5m54s (x3 over 68m)  flagger  New revision detected! Scaling up account.shop\n  Warning  Synced  5m24s                flagger  canary deployment account.shop not ready: waiting for rollout to finish: 1 of 2 updated replicas are available\n  Normal   Synced  4m54s (x3 over 68m)  flagger  Starting canary analysis for account.shop\n  Normal   Synced  4m54s (x3 over 68m)  flagger  Advance account.shop canary weight 25\n  Normal   Synced  3m54s (x3 over 67m)  flagger  Advance account.shop canary weight 50\n  Normal   Synced  3m24s (x2 over 66m)  flagger  Copying account.shop template spec to account-primary.shop\n  Normal   Synced  2m54s (x2 over 66m)  flagger  Routing all traffic to primary\n  Normal   Synced  2m24s (x2 over 65m)  flagger  Promotion completed! Scaling down account.shop\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("ul",[e("li",[s._v("Slack message 수신"),e("br"),s._v("\n: 시작 message, 정상 종료 message 수신")])]),s._v(" "),e("img",{attrs:{src:t(717),width:"40%",height:"40%"}}),s._v(" "),e("h2",{attrs:{id:"ingress-canary-release"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ingress-canary-release"}},[s._v("#")]),s._v(" Ingress Canary Release")]),s._v(" "),e("p",[s._v("TBD")])])}),[],!1,null,null,null);a.default=n.exports}}]);