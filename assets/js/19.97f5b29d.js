(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{707:function(s,a,t){s.exports=t.p+"assets/img/flux-eks-architecture.85c5e83e.png"},708:function(s,a,t){s.exports=t.p+"assets/img/flux-dashboard-cluster.740e3ec5.png"},709:function(s,a,t){s.exports=t.p+"assets/img/flux-dashboard-control-plane.be1bf7ee.png"},770:function(s,a,t){"use strict";t.r(a);var e=t(15),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("Flux v2 는 2020년 7월에 최초 release 되었으며, 현재는 참고 reference 가 그다지 많지는 않다. v1 과 v2 의 차이점을 공식 문서에서는 아래와 같이 간단하게 얘기하고 있다.")]),s._v(" "),e("blockquote",[e("p",[s._v("Flux v1 is a monolithic do-it-all operator; Flux v2 separates the functionalities into specialized controllers, collectively called the GitOps Toolkit.")])]),s._v(" "),e("p",[s._v("manifest 선언 형식, 기본 namespace 변경, 분리되어 배포되는 GOTK component 등으로 인하여, v1 의 reference 를 참고하여 작업하는 것은 매우 어렵다. "),e("u",[e("em",[s._v("새로 처음부터 구성하는 것이 낫다.")])])]),s._v(" "),e("p",[s._v("AWS Managed Service 로 제공되는 CI Pipeline 을 사용하여 Docker image 를 build 하고, FluxCD 를 활용하여 Amazon EKS cluster 에 자동으로 배포하는 CD 구성을 작업하였다.")]),s._v(" "),e("ul",[e("li",[s._v("구성 Architecture")])]),s._v(" "),e("p",[e("img",{attrs:{src:t(707),alt:""}})]),s._v(" "),e("h2",{attrs:{id:"prerequisite"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#prerequisite"}},[s._v("#")]),s._v(" Prerequisite")]),s._v(" "),e("ul",[e("li",[s._v("사전에 구성한 Amazon EKS cluster")]),s._v(" "),e("li",[s._v("사전에 구성한 ECR")]),s._v(" "),e("li",[s._v("사전에 구성한 AWS Code Pipeline (CodeCommit + CodeBuild)")]),s._v(" "),e("li",[s._v("Flux CLI 설치\n"),e("ul",[e("li",[s._v("flux 설치 후, cluster 및 kubectl 등의 version 충족 여부 확인")])])])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ flux --version\n\nflux version "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.14")]),s._v(".2\n\n$ flux check --pre\n\n► checking prerequisites\n✔ kubectl "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.21")]),s._v(".1 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.18")]),s._v(".0-0\n✔ Kubernetes "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.19")]),s._v(".6-eks-49a6c0 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.16")]),s._v(".0-0\n✔ prerequisites checks passed\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("h2",{attrs:{id:"quick-start"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#quick-start"}},[s._v("#")]),s._v(" Quick Start")]),s._v(" "),e("p",[s._v("Flux CLI bootstrap 을 실행하여, flux-system namespace 에 flux v2 controller 를 배포.")]),s._v(" "),e("h3",{attrs:{id:"bootstrap"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#bootstrap"}},[s._v("#")]),s._v(" Bootstrap")]),s._v(" "),e("p",[s._v("public 저장소인 github 를 사용하여 bootstrap 하는 가이드가 주로 많이 있으나, generic 한 git 저장소를 통한 배포 테스트를 위해서 "),e("u",[s._v("AWS CodeCommit")]),s._v(" 에 repository 를 생성하였다.   bootstrap 실행 시, ssh 혹은 https 를 통하여 해당 repository 에 flux v2 manifest 를 push 하고, reconciliation 을 실행한다.")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("flux bootstrap "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--url"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("git repository url"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--username"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("username"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--password"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("password"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--token-auth"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--path"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("clusters/my-cluster\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("설치 진행 순서는 대략 아래와 같다.")]),s._v(" "),e("ol",[e("li",[s._v("flux manitfest 를 생성하여 git repository 에 push")]),s._v(" "),e("li",[s._v("reconcile 을 실행하여, cluster 에 flux gotk component 배포")]),s._v(" "),e("li",[s._v("GitRepository source 생성 및 인증 secret 등을 생성")]),s._v(" "),e("li",[s._v("Kustomize reconciliation 생성")]),s._v(" "),e("li",[s._v("git repository 에 push 후, reconcile 실행하여 custom resource 생성")])]),s._v(" "),e("ul",[e("li",[s._v("git repository manifest 생성 내역"),e("br"),s._v("\n: 설치 후, 아래와 같은 manifest 가 git repository 에 push 된 것을 확인할 수 있다.")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("./clusters/\n└── eks "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <- path=clusters/eks")]),s._v("\n    └── flux-system              "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <- namespace dir generated by bootstrap")]),s._v("\n        ├── gotk-components.yaml "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <- gotk component manifest")]),s._v("\n        ├── gotk-sync.yaml       "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <- GitRepository, Kustomization manifest")]),s._v("\n        └── kustomization.yaml   "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <- 위 yaml 을 kustomize 로 실행하기 위한, kustomization (kustomize API)")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("ul",[e("li",[s._v("gotk component 생성 내역"),e("br"),s._v("\n: 위에 생성된 gotk-components.yaml 에 정의된 내역을 그대로 생성한다.")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ kubectl get po -n flux-system\n\nNAME                                          READY   STATUS      RESTARTS   AGE\nhelm-controller-5fc96c6bcf-drrfq              "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          8d\nimage-automation-controller-bb685fd95-f5wsp   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          19d\nimage-reflector-controller-58c57b8f7d-fmnj2   "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          8d\nkustomize-controller-7844d96565-5m2x9         "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          19d\nnotification-controller-7c9d5cdc4c-gkwkc      "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          19d\nsource-controller-655c987dff-pz9df            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          8d\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("h3",{attrs:{id:"source-reconciliation"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#source-reconciliation"}},[s._v("#")]),s._v(" Source & reconciliation")]),s._v(" "),e("p",[s._v("bootstrap 의 결과로 생성된 manifest 중, gotk-sync.yaml 에는 GitRepository 와 Kustomization 이 정의되어 있다."),e("br"),s._v("\n설치 과정에서 parameter 로 입력한 접속 정보를 가지고 secret 을 생성하여, git repository access 를 위해 사용한다.")]),s._v(" "),e("ul",[e("li",[s._v("gotk-sync.yaml")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" source.toolkit.fluxcd.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" GitRepository\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flux"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flux"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1m0s\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ref")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("branch")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" eks\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("secretRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flux"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("url")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" <git repository url"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kustomize.toolkit.fluxcd.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Kustomization\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flux"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flux"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 3m0s\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ./clusters/eks\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("prune")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("sourceRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" GitRepository\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flux"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("validation")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" client\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br")])]),e("ul",[e("li",[s._v("flux source, reconciliation 생성 내역"),e("br"),s._v("\n: gotk-sync.yaml 에 정의된 내역이며, flux resource 는 flux CLI 를 통해 조회할 수도 있다. flux-system 이라는 name 으로 공통으로 생성된다.")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ flux get "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" all\n\nNAME                     \tREADY\tMESSAGE                                                        \tREVISION                                     \tSUSPENDED\ngitrepository/flux-system\tTrue \tFetched revision: eks/9e7e6e799fd7450c20fe6b99e606d4d2d725efb5 \teks/9e7e6e799fd7450c20fe6b99e606d4d2d725efb5 \tFalse\n\n$ flux get kustomizations\n\nNAME            \tREADY\tMESSAGE                                                        \tREVISION                                     \tSUSPENDED\nflux-system     \tTrue \tApplied revision: eks/9e7e6e799fd7450c20fe6b99e606d4d2d725efb5 \teks/9e7e6e799fd7450c20fe6b99e606d4d2d725efb5 \tFalse\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("h3",{attrs:{id:"deploy-test"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#deploy-test"}},[s._v("#")]),s._v(" Deploy Test")]),s._v(" "),e("p",[s._v("path 로 지정한 directory 아래에, k8s object manifest 를 유형별로 정의하여, git repository 에 push 하였다."),e("br"),s._v("\n모두 정상적으로 배포가 완료되었다.")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("├── clusters\n│   └── eks\n│       ├── flux-system\n│       │   ├── gotk-components.yaml\n│       │   ├── gotk-sync.yaml\n│       │   └── kustomization.yaml\n│       └── shop                  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <- directory 를 생성하고, 관련 yaml 을 생성")]),s._v("\n│           ├── ecr-job.yml\n│           ├── shop-configmap.yml "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# app. config")]),s._v("\n│           ├── shop-deployment.yml "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# app. deployment")]),s._v("\n│           ├── shop-ingress.yml "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# app. ingress")]),s._v("\n│           ├── shop-policy.yml\n│           ├── shop-registry.yml\n│           ├── shop-service.yml "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# app. service")]),s._v("\n│           └── update-policy.yml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("p",[e("s",[s._v("특이 사항으로, k8s API 로 정의된 yaml 들만 Kustomization reconciliation 에 의해 apply / patch / delete 가 실행이 된다."),e("br"),s._v("\n예를 들면, 위 파일 중 update-policy.yml 은 fluxcd API 중 ImageUpdateAutomation manifest 인데, 이 파일을 수정해서 push 하면, 자동으로 reconciliation 이 이루어지지 않는다."),e("br"),s._v(" "),e("u",[e("em",[s._v("즉, FluxCD 의 설정 자체에 영향을 주는 yml 파일을, git repository 에서 관리하더라도, 소스코드 push 후 flux CLI 를 통해 reconcile 명령을 실행해 주어야 실제로 배포가 실행된다.")])])])]),s._v(" "),e("p",[s._v("아래와 같이, fluxcd kustomization 을 source 인 git repository 기반으로 reconcile 하겠다는 command 실행을 하면 수동 반영이 가능하다.")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ flux reconcile kustomization flux-system --with-source\n\n► annotating GitRepository flux-system "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" flux-system namespace\n✔ GitRepository annotated\n◎ waiting "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" GitRepository reconciliation\n✔ GitRepository reconciliation completed\n✔ fetched revision eks/9e7e6e799fd7450c20fe6b99e606d4d2d725efb5\n► annotating Kustomization flux-system "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" flux-system namespace\n✔ Kustomization annotated\n◎ waiting "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" Kustomization reconciliation\n✔ Kustomization reconciliation completed\n✔ applied revision eks/9e7e6e799fd7450c20fe6b99e606d4d2d725efb5\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("h2",{attrs:{id:"ci-cd-automation"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ci-cd-automation"}},[s._v("#")]),s._v(" CI/CD Automation")]),s._v(" "),e("p",[s._v("현재 구성된 환경에서는 k8s manifest 를 관리하는 별도의 git repository 를 생성하여, FluxCD 가 repository 의 변경을 감지하여 k8s object 를 변경하고 있다."),e("br"),s._v("\nAWS Managed Service 를 활용하여, source code 빌드 및 docker image build / push 후, 자동으로 git repository 의 deployment image tag 를 수정하여, 이를 통해 FluxCD 의 reconciliation 이 실행될 수 있도록 구성 및 테스트한 내역이다.")]),s._v(" "),e("ul",[e("li",[s._v("CI/CD workflow\n"),e("ul",[e("li",[s._v("DEV: Local code 수정 및 git repository commit and push.")]),s._v(" "),e("li",[s._v("CI: maven source code build, docker image build.")]),s._v(" "),e("li",[s._v("CI: timestamp 기반 image tagging 및 push.")]),s._v(" "),e("li",[s._v("CD: Flux 의 image scanning 을 통하여, image 관리 정책에 따른 최신 image metadata 조회. (Image reflector controller)")]),s._v(" "),e("li",[s._v("CD: git repository 의 deployment manifest 의 image tag 를 최신으로 수정. (Image automation controller)")]),s._v(" "),e("li",[s._v("CD: k8s cluster 에 배포 (Flux Git to cluster reconciliation)")])])])]),s._v(" "),e("blockquote",[e("p",[s._v("FluxCD Guide 참조"),e("br"),s._v(" "),e("a",{attrs:{href:"https://fluxcd.io/docs/guides/image-update/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://fluxcd.io/docs/guides/image-update/"),e("OutboundLink")],1)])]),s._v(" "),e("p",[s._v("작업을 위해, image 관련 gotk API resource 를 cluster 에 생성하여 관리한다.")]),s._v(" "),e("hr"),s._v(" "),e("p",[s._v("| "),e("small",[s._v("Amazon ECR 을 활용하기 위해서, IAM Role for Service Account 설정 및 ECR credential 갱신을 위한 cronjob 등을 생성하는 과정이 필요했으며, 생략,,,")])]),s._v(" "),e("hr"),s._v(" "),e("h3",{attrs:{id:"imagerepository"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#imagerepository"}},[s._v("#")]),s._v(" ImageRepository")]),s._v(" "),e("p",[s._v("위에서 배포한 application 은 container 7 개로 구성되어 있어, ECR 에 총 7개의 Repository 가 생성되어 있었으며, 해당 image 기반으로 7개의 deployment 가 생성되어 있는 상태이다.")]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ kubectl get deploy\n\nNAME            READY   UP-TO-DATE   AVAILABLE   AGE\naccount         "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           36d\napigateway      "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/0     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("           36d\nbff             "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           36d\ncart            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           36d\norder           "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           36d\npayment         "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           36d\nproduct         "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           36d\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("ul",[e("li",[s._v("ImageRepository manifest 예시"),e("br"),s._v("\n: 아래와 같은 ImageRepository 를 repository 별로 모두 생성하여, Image reflector controller 가 image 를 scanning 할 수 있도록 credential 등이 정상적으로 설정되어야, ImageRepository 도 정상적으로 생성된다.")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" image.toolkit.fluxcd.io/v1alpha1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ImageRepository\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" account\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flux"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("secretRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ecr"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("credentials "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cronjob 을 통해 갱신되는 ECR credential")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" <image repository url"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1m0s\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("ul",[e("li",[s._v("ImageRepository resource 생성 내역"),e("br"),s._v("\n: flux CLI 혹은 kubectl 로 조회 가능하며, repository 별로 생성된 모든 tag 를 설정된 interval 에 따라 scan 한다. repository 별 scan 을 suspend 하여 관리 가능.")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ flux get images repository\n\nNAME      \tREADY\tMESSAGE                       \tLAST SCAN                \tSUSPENDED\naccount   \tTrue \tsuccessful scan, found "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" tags \t"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-06-12T08:59:27+09:00\tFalse\napigateway\tTrue \tsuccessful scan, found "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" tags \t"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-06-12T08:59:28+09:00\tFalse\nbff       \tTrue \tsuccessful scan, found "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" tags\t"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-06-12T08:59:27+09:00\tFalse\ncart      \tTrue \tsuccessful scan, found "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" tags \t"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-06-12T08:59:27+09:00\tFalse\norder     \tTrue \tsuccessful scan, found "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" tags \t"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-06-12T08:59:27+09:00\tFalse\npayment   \tTrue \tsuccessful scan, found "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" tags \t"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-06-12T08:59:27+09:00\tFalse\nproduct   \tTrue \tsuccessful scan, found "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" tags \t"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-06-12T08:59:27+09:00\tFalse\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("h3",{attrs:{id:"imagepolicy"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#imagepolicy"}},[s._v("#")]),s._v(" ImagePolicy")]),s._v(" "),e("p",[s._v("Image update automation 을 위해, 반영하기 위한 image tag 를 가져오기 위한 정책을 생성한다."),e("br"),s._v("\n아래와 같은 다양한 설정이 가능하며, 아래에서는 timestamp 기준으로 생성된 최신 version 의 tag 를 가져오기 위해 아래와 같이 alphabetical policy 를 설정했다.")]),s._v(" "),e("ul",[e("li",[s._v("Image Policy List\n"),e("ul",[e("li",[s._v("SemVer: semantic version 및 연산자 사용을 지원한다. range, in 등의 제약조건 설정 가능. (ex> range: '>=1.0.0', range: '1.9.x')")]),s._v(" "),e("li",[s._v("Alphabetical: 알파벳순 및 오름차순/내림차순 선택 및 tag 를 sorting 하여, 가장 마지막에 조회되는 tag 를 가져온다.")]),s._v(" "),e("li",[s._v("Numerical: 모든 숫자가 숫자로 정렬이 가능하면 오름차순/내림차순 선택 및 tag 를 sorting 하여, 가장 마지막에 조회되는 tag 를 가져온다.")])])])]),s._v(" "),e("blockquote",[e("p",[s._v("Image Policy 관련 정책, 공식 docs 참조"),e("br"),s._v(" "),e("a",{attrs:{href:"https://fluxcd.io/docs/components/image/imagepolicies/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://fluxcd.io/docs/components/image/imagepolicies/"),e("OutboundLink")],1)])]),s._v(" "),e("ul",[e("li",[s._v("ImagePolicy manifest 예시"),e("br"),s._v("\n: repository 별 policy 를 각각 생성했다.")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" image.toolkit.fluxcd.io/v1alpha1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ImagePolicy\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" account\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flux"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imageRepositoryRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" account\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alphabetical")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 문자열 오름차순으로 최신 이미지를 정리하는 정책을 적용.")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("order")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" asc\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("ul",[e("li",[s._v("ImagePolicy resource 생성 내역"),e("br"),s._v("\n: flux CLI 혹은 kubectl 로 조회 가능. 현재 Latest Image 로 Policy 에서 가져온 latest tag 를 확인할 수 있다.")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ flux get images policy\n\nNAME      \tREADY\tMESSAGE                                                                         LATEST IMAGE\naccount   \tTrue \tLatest image tag "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'<ecr-domain>/shop/account'")]),s._v(" resolved to: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("20210608052721")]),s._v("   \t"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("ecr-domain"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/shop/account:20210608052721\napigateway\tTrue \tLatest image tag "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'<ecr-domain>/shop/apigateway'")]),s._v(" resolved to: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("20210608010319")]),s._v("\t"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("ecr-domain"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/shop/apigateway:20210608010319\nbff       \tTrue \tLatest image tag "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'<ecr-domain>/shop/bff'")]),s._v(" resolved to: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("20210608024231")]),s._v("       \t"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("ecr-domain"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/shop/bff:20210608024231\ncart      \tTrue \tLatest image tag "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'<ecr-domain>/shop/cart'")]),s._v(" resolved to: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("20210608054357")]),s._v("      \t"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("ecr-domain"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/shop/cart:20210608054357\norder     \tTrue \tLatest image tag "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'<ecr-domain>/shop/order'")]),s._v(" resolved to: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("20210608071228")]),s._v("     \t"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("ecr-domain"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/shop/order:20210608071228\npayment   \tTrue \tLatest image tag "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'<ecr-domain>/shop/payment'")]),s._v(" resolved to: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("20210608071556")]),s._v("   \t"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("ecr-domain"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/shop/payment:20210608071556\nproduct   \tTrue \tLatest image tag "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'<ecr-domain>/shop/product'")]),s._v(" resolved to: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("20210608071959")]),s._v("   \t"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("ecr-domain"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/shop/product:20210608071959\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("h3",{attrs:{id:"imageupdateautomation"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#imageupdateautomation"}},[s._v("#")]),s._v(" ImageUpdateAutomation")]),s._v(" "),e("p",[s._v("Image scan 및 latest tag 정책 적용 후에, ImageUpdateAutomation resource 를 생성한다."),e("br"),s._v("\nflux-system 의 k8s manifest git repository 의 image tag 를 관리하는 manifest 를 찾아서 tag 명을 latest tag 로 업데이트.")]),s._v(" "),e("ul",[e("li",[s._v("ImageUpdateAutomation manifest 예시"),e("br"),s._v("\n: ImageUpdateAutomation 은 하나만 생성하면 된다. image update 의 전체 process suspend 가능.")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" image.toolkit.fluxcd.io/v1alpha2\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ImageUpdateAutomation\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flux"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flux"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("sourceRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" GitRepository\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" flux"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# flux system 을 설치하면서 생성한, k8s manifest 관리를 위한 GitRepository Resource")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("interval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1m\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("update")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("strategy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Setters\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ./clusters/eks\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("git")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("checkout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ref")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("branch")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" eks "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# checkout 할 branch 설정")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("commit")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("author")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" fluxbot\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("email")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" fluxbot@example.com\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("messageTemplate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token scalar string"}},[s._v("\n        An automated update from FluxBot\n        [ci skip]")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("push")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("branch")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" eks\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br")])]),e("ul",[e("li",[s._v("ImageUpdateAutomation resource 생성 내역"),e("br"),s._v("\n: GitRepository 에 최근 commit message 등 조회 가능.")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("$ flux get images update\n\nNAME       \tREADY\tMESSAGE                                                     \tLAST RUN                 \tSUSPENDED\nflux-system\tTrue \tno updates made"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" last commit 515a681 at "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-06-08T07:23:03Z\t"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("-06-12T09:22:02+09:00\tFalse\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h4",{attrs:{id:"deployment-marker-추가"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#deployment-marker-추가"}},[s._v("#")]),s._v(" | Deployment Marker 추가")]),s._v(" "),e("p",[e("b",[e("u",[e("em",[s._v("마지막으로, Image Update 정책을 사용하겠다는 것을 flux 에서 찾아서 업데이트할 수 있게, marker 추가 필요.")])])]),e("br"),s._v("\n아래의 예시 처럼, image name 옆에,")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('# {"$imagepolicy": "flux-system:<policy-name>"}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("위와 같은 marker 를 추가해주어야 한다. "),e("em",[s._v("주석 아님.")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" account\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" shop\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" account\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" account\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" account\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" <ecr"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("domain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("20210608052721")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# {"$imagepolicy": "flux-system:account"}')]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br")])]),e("h4",{attrs:{id:"flux-bot-이-수정한-source-commit-이력"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#flux-bot-이-수정한-source-commit-이력"}},[s._v("#")]),s._v(" flux-bot 이 수정한 source commit 이력")]),s._v(" "),e("p",[s._v("image tag만 찾아서 변경하고, 이를 flux 의 Kustomization 이 reconcile 실행하여 k8s cluster 에 변경된 spec 의 deployment 를 배포.")]),s._v(" "),e("div",{staticClass:"language-git line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-git"}},[e("code",[s._v("diff --git a/clusters/eks/shop/shop-deployment.yml b/clusters/eks/shop/shop-deployment.yml\nindex 5d947df..74f8196 100644\n"),e("span",{pre:!0,attrs:{class:"token deleted"}},[s._v("--- a/clusters/eks/shop/shop-deployment.yml")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token inserted"}},[s._v("+++ b/clusters/eks/shop/shop-deployment.yml")]),s._v("\n@@ -248,7 +248,7 @@ spec:\n     spec:\n       containers:\n       - name: product\n"),e("span",{pre:!0,attrs:{class:"token deleted"}},[s._v('-        image: 170247361816.dkr.ecr.ap-northeast-2.amazonaws.com/shop/product:20210608071959 # {"$imagepolicy": "flux-system:product"}')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token inserted"}},[s._v('+        image: 170247361816.dkr.ecr.ap-northeast-2.amazonaws.com/shop/product:20210608041922 # {"$imagepolicy": "flux-system:product"}')]),s._v("\n         ports:\n         - containerPort: 8184\n         resources:\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("h2",{attrs:{id:"monitoring"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#monitoring"}},[s._v("#")]),s._v(" Monitoring")]),s._v(" "),e("p",[s._v("Flux는 kube-prometheus-stack 을 사용하여, 아래와 같은 기본적인 monitoring manifest 를 github main 저장소를 통해 제공한다.")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("기본 제공 monitoring manifest")]),s._v(" "),e("ul",[e("li",[s._v("Prometheus Operator -Kubernetes에서 Prometheus 클러스터 관리")]),s._v(" "),e("li",[s._v("Prometheus - Flux 컨트롤러 및 Kubernetes API에서 메트릭 수집")]),s._v(" "),e("li",[s._v("Grafana Dashbards -Flux 컨트롤 플레인 리소스 사용량 및 조정 통계를 표시합니다.")]),s._v(" "),e("li",[s._v("kube-state-metrics - Kubernetes 객체의 상태에 대한 메트릭을 생성합니다.")])])]),s._v(" "),e("li",[e("p",[s._v("flux v2 github 의 monitoring manifest 참조"),e("br"),s._v("\n: 정의된 kustomize 로 prometheus / grafana 를 배포하였으며, 기본 dashboard 가 포함되어 있다."),e("br"),s._v(" "),e("a",{attrs:{href:"https://github.com/fluxcd/flux2/tree/main/manifests/monitoring",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/fluxcd/flux2/tree/main/manifests/monitoring"),e("OutboundLink")],1)])])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" ./flux2/tree/main/manifests/monitoring\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" tree grafana prometheus kustomization.yaml    \ngrafana\n├── dashboards\n│   ├── cluster.json\n│   └── control-plane.json\n├── datasources.yaml\n├── deployment.yaml\n├── kustomization.yaml\n├── providers.yaml\n└── service.yaml\nprometheus\n├── account.yaml\n├── deployment.yaml\n├── kustomization.yaml\n├── prometheus.yml\n├── rbac.yaml\n└── service.yaml\nkustomization.yaml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("h3",{attrs:{id:"flux-monitoring-resource"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#flux-monitoring-resource"}},[s._v("#")]),s._v(" Flux Monitoring Resource")]),s._v(" "),e("p",[s._v("FluxCD 는 monitoring stack 설치를 flux resource 생성을 통해 설치하도록 가이드 함."),e("br"),s._v("\nfluxv2 의 Github main repository 를 GitRepository resource 로 생성하고, monitoring 을 배포하기 위한 Kustomization resource 를 생성.")]),s._v(" "),e("hr"),s._v(" "),e("p",[s._v("| "),e("small",[s._v("전체 monitoring stack 이 아닌, 필요에 따른 prometheus 와 grafana 만 별도로 설치하였음.")])]),s._v(" "),e("hr"),s._v(" "),e("ul",[e("li",[s._v("flux source 및 reconciliation 생성"),e("br"),s._v("\n: Github main 저장소를 source 로 생성하고, source 의 monitoring directory 에 있는 kustomization.yaml 기반으로 reconciliation 을 생성.")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" flux create "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" monitoring "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --interval"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("30m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --url"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://github.com/fluxcd/flux2 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --branch"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("main\n\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" flux create kustomization monitoring-stack "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --interval"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("1h "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --prune"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --source"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("monitoring "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  --path"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./manifests/monitoring"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# prometheus / grafana 배포를 위한 kustomize manifest path.")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("ul",[e("li",[s._v("flux resource 생성 내역"),e("br"),s._v("\n: application manifest 관련 source / reconciliation 외에 추가로 monitoring 관련 resource 가 생성되었음.")])]),s._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" flux get "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("\nNAME       \tREADY\tMESSAGE                                                        \tREVISION                                     \tSUSPENDED\nflux-system\tTrue \tFetched revision: eks/08231b0c6993577d71af7f0ac069381684d43697 \teks/08231b0c6993577d71af7f0ac069381684d43697 \tFalse\nmonitoring \tTrue \tFetched revision: main/fd364828a120421b9a2ca169c4284d78eeb38d16\tmain/fd364828a120421b9a2ca169c4284d78eeb38d16\tFalse\n\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" flux get kustomization\nNAME            \tREADY\tMESSAGE                                                        \tREVISION                                     \tSUSPENDED\nflux-system     \tTrue \tApplied revision: eks/08231b0c6993577d71af7f0ac069381684d43697 \teks/08231b0c6993577d71af7f0ac069381684d43697 \tFalse\nmonitoring-stack\tTrue \tApplied revision: main/fd364828a120421b9a2ca169c4284d78eeb38d16\tmain/fd364828a120421b9a2ca169c4284d78eeb38d16\tFalse\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("h3",{attrs:{id:"flux-dashboards"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#flux-dashboards"}},[s._v("#")]),s._v(" Flux Dashboards")]),s._v(" "),e("p",[s._v("FluxCD 에서 제공하는 monitoring dashboard.")]),s._v(" "),e("hr"),s._v(" "),e("p",[s._v("| "),e("small",[s._v("기본 제공 dashboard 에는, ImageRepository 및 ImageUpdateAutomation 관련 monitoring 은 없음.")]),e("br"),s._v("\n| "),e("small",[s._v("또한, monitoring 과 연계 하여, FluxCD Alert 및 Notification 기능과의 연계도 가능할 것으로 보임,,,")])]),s._v(" "),e("hr"),s._v(" "),e("ul",[e("li",[s._v("Flux Cluster Status"),e("br"),s._v("\n: FluxCD 에서 생성한 custrom resource monitoring\n"),e("ul",[e("li",[s._v("reconciliations / sources 의 list-up 및 상태")]),s._v(" "),e("li",[s._v("reconciliatino, soure acquisition 의 수행 시간")])])])]),s._v(" "),e("p",[e("img",{attrs:{src:t(708),alt:""}})]),s._v(" "),e("ul",[e("li",[s._v("Flux Control Plane"),e("br"),s._v("\n: FluxCD control plane 으로 생성된, k8s object monitoring\n"),e("ul",[e("li",[s._v("Flux Controller 상태 및 자원 사용율 조회")]),s._v(" "),e("li",[s._v("Controller 의 Kubernetes API request 상태 확인")]),s._v(" "),e("li",[s._v("reconciliation request 상태 확인 (Kustomization, HelmRelease)")])])])]),s._v(" "),e("p",[e("img",{attrs:{src:t(709),alt:""}})])])}),[],!1,null,null,null);a.default=n.exports}}]);